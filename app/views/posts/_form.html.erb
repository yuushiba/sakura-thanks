<div class="container mx-auto px-4">
  <div class="max-w-2xl mx-auto">
    <%= form_with(model: post, local: true, class: "space-y-6") do |f| %>
      <%# エラーメッセージ表示部分 %>
      <% if post.errors.any? %>
        <div class="space-y-2 mb-4">
          <% post.errors.full_messages.each do |message| %>
            <div class="alert alert-error w-full text-sm shadow-lg">
              <%= message %>
            </div>
          <% end %>
        </div>
      <% end %>
      
  <%# 画像プレビュー部分 %>
  <div data-controller="image-text" class="relative">
  <div id="image-preview" class="w-full flex items-center justify-center overflow-hidden" style="background-color: #D9D9D9 !important; min-height: 200px;">
    <% if post.persisted? && post.image.attached? %>
      <%= image_tag post.preview_with_text, class: "w-full h-full object-cover" %>
    <% else %>
      <div class="w-1/2 h-1/2 flex items-center justify-center">
        <span class="text-gray-600">画像を選択してください</span>
      </div>
    <% end %>
  </div>

  <%# プレビュー用のオーバーレイテキスト - 編集時のみ表示 %>
  <% if post.overlay_text.present? %>
    <div data-image-text-target="textPreview" class="hidden">
      <%= post.overlay_text %>
    </div>
  <% end %>
</div>
      
     <div>
       <%= f.label :title, "タイトル", class: "block text-sm font-medium mb-2", style: "color: #073472;" %>
       <%= f.text_field :title, 
           class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary", 
           placeholder: "タイトルを入力してください" %>
     </div>

     <div>
       <%= f.label :content, "内容", class: "block text-sm font-medium mb-2", style: "color: #073472;" %>
       <%= f.text_area :content, 
           rows: 5, 
           class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
           placeholder: "内容を入力してください" %>
     </div>

     <div>
       <%= f.label :image, "画像(任意)", class: "block text-sm font-medium mb-2", style: "color: #073472;" %>
       <%= f.file_field :image, 
           class: "w-full rounded-lg border border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
           accept: "image/jpeg,image/gif,image/png" %>
     </div>

     <div data-controller="image-text">
     <div>
       <%= f.label :overlay_text, "画像に入れたい文字(任意)", class: "block text-sm font-medium mb-2", style: "color: #073472;" %>
       <%= f.text_field :overlay_text, 
           class: "w-full rounded-lg border-gray-300 shadow-sm focus:border-primary focus:ring-primary",
           placeholder: "文字を入力してください",
           data: { "image-text-target": "input" } %>
     </div>
   
     <div class="mt-4">
       <label class="block text-sm font-medium mb-2" style="color: #073472;">文字の位置調整(任意)</label>
       <div class="flex justify-center gap-2">
         <%= f.hidden_field :text_x_position, data: { "image-text-target": "xPosition" } %>
         <%= f.hidden_field :text_y_position, data: { "image-text-target": "yPosition" } %>
         <button type="button" class="btn btn-sm btn-primary" data-action="image-text#moveUp">↑</button>
         <button type="button" class="btn btn-sm btn-primary" data-action="image-text#moveLeft">←</button>
         <button type="button" class="btn btn-sm btn-primary" data-action="image-text#moveRight">→</button>
         <button type="button" class="btn btn-sm btn-primary" data-action="image-text#moveDown">↓</button>
       </div>
     </div>
   </div>

     <div class="mt-8 text-center space-x-4">
       <%= link_to "キャンセル", mypage_path, class: "btn btn-neutral" %>
       <%= f.submit (post.new_record? ? "投稿する" : "更新する"), 
           class: "btn custom-text border-none hover:opacity-80", 
           style: "background-color: #DD7594;" %>
     </div>
   <% end %>
 </div>
</div>

<%= javascript_tag nonce: true do %>
  document.addEventListener('turbo:load', function() {
    setupImagePreview();
  });

  document.addEventListener('DOMContentLoaded', function() {
    setupImagePreview();
  });

  function setupImagePreview() {
    const imageInput = document.querySelector('input[type="file"]');
    const previewArea = document.querySelector('#image-preview');
    
    if (!imageInput || !previewArea) return;

    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewArea.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-cover">`;
        }
        reader.readAsDataURL(file);
      }
    });
  }
<% end %>
